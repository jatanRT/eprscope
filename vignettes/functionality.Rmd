---
title: "Basic Functionality"
subtitle: "Processing and Analysis of the Wuster's Blue EPR Spectrum"
output: 
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    mathjax: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
    toc: TRUE
number_sections: TRUE
link-citations: TRUE
bibliography: functionality.bib
csl: iso690-numeric-en.csl
vignette: >
  %\VignetteIndexEntry{Basic Functionality}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r knitr-setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7.2,
  fig.height = 4.8
)
options(
  rmarkdown.html_vignette.check_title = FALSE
)
```

$\require{mhchem}$

```{r setup, include = FALSE}
library(eprscope)
library(icons)
library(knitr)
library(patchwork)
library(flextable)
```

# Introduction

The *Wuster's* reagent got his name according to *C. Wuster* who discovered the oxidation products of *p*-phenylenediamine derivatives [@GramppGpda2005]. It is a suitable compound to demonstrate the feasibility of the Electron paramagnetic resonance (EPR) combined with the *in situ* electrochemistry/voltammetry because of the one-electron oxidation [@PetrAse1996]:

```{=tex}
\begin{equation}
\ce{TMPD <=>[-e^-] TMPD^{.+}}
(\#eq:tmpdoxid)
\end{equation}
```
where $\ce{TMPD}$ stands for *N,N,N',N'*-tetramethyl-*p*-phenylenediamine (Wuster's reagent) abbreviation. The second oxidation step into di-cationic structure (not depicted in Equation \@ref(eq:tmpdoxid)) appears far behind ($\approx (0.5-0.6)\,\mathrm{V}$) from the first one [@Dadpou2018]. Therefore, upon the first oxidation step, it changes its state from diamagnetic (not visible by EPR) to paramagnetic (with one unpaired electron) observable by characteristic EPR spectrum, as shown below. Moreover, such change is not only visible by "magic" where the nicely structured EPR spectrum rises from the noisy background upon oxidation. Additionally, it is also associated with the exciting color change from almost colorless to violet-blue. Accordingly and unsurprisingly, **the radical cation of *N,N,N',N'*-tetramethyl-*p*-phenylenediamine is** described as ***Wuster's*** **blue**. Such an example will demonstrate the main workflow to process and analyse the EPR spectra by the `{eprscope}` `r icons::icon_style(fontawesome("box-open"), fill = "brown")` . The $\ce{TMPD^{.+}}$ was generated electrochemically by potentiostatic electrolysis at 0.308 V (*vs* Ag-*quasiref.* electrode) of the corresponding $1\,\mathrm{mM}$ $\ce{TMPD}$ solution in 0.3 M TBAPF~6~/DMSO.

# Drawing of Molecular Structures

Structure of the investigated compound can be depicted by the following function (`draw_molecule_by_rcdk()`) based on those coming from [{rcdk}](https://cdk-r.github.io/cdkr/) `r icons::icon_style(fontawesome("box-open"), fill = "brown")` (see also [@GuhaRrcdk2007]) which is an `r icons::bioicons("R")` toolbox of the [Chemistry Development Kit](https://cdk.github.io/) an open source modular java libraries for the chemoinformatics [@WillighagenCDK2017].

```{r draw-molecule}

# radical cation of previosly described Wuster's Reagent equivalent
# to N,N,N',N'-tetramethyl-p-phenylenediamine (TMPD) radical cation
draw_molecule_by_rcdk(
  molecule = "CN(C)[C+]1C([H])=C([H])[C.]([N](C)C)C([H])=C1[H]",
  type = "smiles",
  style = "cob",
  mol.label = expression(TMPD^+.~"("~Wuster*"'"*s~Blue~")"),
  mol.label.color = "yellow",
  suppressh = F
)

```

This function belongs to the package family/section `Visualization and Graphics` and enables to create image of molecular structures either by [SMILES and SMART codes](https://chem.libretexts.org/Courses/Fordham_University/Chem1102%3A_Drug_Discovery_-_From_the_Laboratory_to_the_Clinic/05%3A_Organic_Molecules/5.08%3A_Line_Notation_(SMILES_and_InChI)) or by loading a **S**tructure **D**ata **F**ile (`.sdf`) [@Sakari2022].

# Reading Text Files and Writing Data Frames

To process the EPR spectral data it is important not only to read the files with *Intensity vs. B* (usually in `.asc`, `.txt`, `.csv` format) but also associated files like those containing the instrumental parameters used to record the EPR spectra (usually in `.DSC` or `.par` format). The information incl. in these files is required to e.g. normalize the Intensity (like $\mathrm{d}I_{\mathrm{EPR}}~/~\mathrm{d}B$ in derivative spectral form) or to evaluate the $g$-factor (position of the spectrum) as well as for simulations of the EPR spectra and to evaluate the kinetic parameters of the radical reactions.

Reading of the instrumental parameters from `.DSC` or `.par` files (corresponding to acquisition software "xenon"/"magnetech" or "winepr", respectively) is provided by several functions for different purposes like e.g. for kinetic measurements or simulations. The general function `readEPR_params_tabs()` summarizes all important parameters in list of data frames and can be converted into individual interactive tables by [{DT}](https://rstudio.github.io/DT/) package ➨

```{r instrum-params-reaad-df-info}

# built-in package file => "TMPD_specelchem_accu_b.par"
tmpd.params.file <- load_data_example(file = "TMPD_specelchem_accu_b.par")
#
# reading the parameter file coming from "winepr" acquisition softw.
tmpd.params <- readEPR_params_tabs(path_to_dsc_par = tmpd.params.file,
                                   origin = "winepr")
#
# the output `tmpd.params` is list consisting
# of the "info" data frame (contaning characters)
tmpd.params$info # or `tmpd.params[["info"]]`

```

```{r instrum-params-reaad-df-params}

# and the second data frame is the "params" one
# containing parameters, their values and units
tmpd.params$params # or `tmpd.params[["params"]]`

```

Finally conversion of the second data frame (`tmpd.params$params`) into interactive table ➨

```{r instrum-params-reaad-DT-interact}

# by function `datatable` from the `DT` package
DT::datatable(data = tmpd.params$params)
#
# the same by
# readEPR_params_tabs(path_to_dsc_par = tmpd.params.file,
#                     origin = "winepr",
#                     interact = "params")

```

The `origin` argument from reading functions reflects the differences in the ASCII text file structure depending on the acquisition software. Moreover, while the intensity can be automatically normalized upon spectrum recording within "xenon"/"magnetech" software, the "winepr" intensity has to be normalized after the measurement if one wants to compare the intensities of two or more EPR spectra. Thus, the reading of the $\ce{TMPD^{.+}}$ spectral data by `readEPR_Exp_Specs()` proceeds as follows with the output in form the universal `data frame` format ➨

```{r spectral-data-read-norm-basic}

# built-in package file => "TMPD_specelchem_accu_b.asc"
tmpd.data.file <- load_data_example(file = "TMPD_specelchem_accu_b.asc")

# The intensity will be normalized by Q value (sensitivity factor)
# and the number of scans (`Nscans`). From the previous parameter/info reading 
# we know: Q = 3500, Nscans = 20. Therefore, reading of the experimental spectra =>
tmpd.data.norm.01 <- readEPR_Exp_Specs(
  path_to_ASC = tmpd.data.file,
  col.names = c("B_G", "dIepr_over_dB"),
  x = 1,
  Intensity = 2,
  qValue = 3500,
  norm.vec.add = 20,
  origin = "winepr"
)
#
# data frame preview 
head(tmpd.data.norm.01)

```

An arbitrary character string may be chosen for the column names (`col.names`)[^1]. However, a safe rule of thumb is to use notation like "quantity_unit" as already shown above for the magnetic flux density $B$. The above described function `readEPR_Exp_specs()` can automatically convert the $B$ values by the argument `convertB.unit=TRUE` (or `FALSE`) depending on the original units "G" or "mT". The reason is because the magnetic flux density in both units is quite often used to display the EPR spectra as well as to calculate additional related quantities like $\Delta B$, $g$ or hyperfine splitting constants $a$. If the `Intensity` has to be normalized also by additional instrumental parameters like *conversion time* and *receiver gain* (automatically performed within "xenon" software)*,* one should use the `quantify_EPR_Norm_const()` function from the `Evaluations and Quantification` family ➨

[^1]: For such reason there are arguments `x` and `Intensity` , pointing to original column indices, in order to properly pick up the corresponding variables.

```{r spectral-data-read-norm}

# calculation of the advanced normalization constant
# by selected parameters from the table above
conv.time.ms <- 8 # conversion time in milliseconds
receiver.gain <- 39905.25 # unitless
sweep.width <- 120 # in G
adv.norm.constant <- quantify_EPR_Norm_const(
  conv.time.ms = conv.time.ms,
  Nscans = 20,
  rg = receiver.gain,
  rg.unit = "Unitless",
  Bsw = sweep.width
)
#
# Therefore, the reading of the experimental 
# data file =>
tmpd.data.norm.02 <- readEPR_Exp_Specs(
  path_to_ASC = tmpd.data.file,
  col.names = c("B_G", "dIepr_over_dB"),
  x = 1,
  Intensity = 2,
  qValue = 3500,
  norm.vec.add = adv.norm.constant,
  origin = "winepr"
)
#
# data frame preview
head(tmpd.data.norm.02)

```

Visualization and/or conversion of data frames (tables) into several formats like `.html` , `.pdf` , `.docx` or `.pptx`. can be provided by the mostly used ["table" packages](https://rfortherestofus.com/2019/11/how-to-make-beautiful-tables-in-r/) (example of interactive data frame by [{DT}](https://rstudio.github.io/DT/) is already shown above). Among them libraries like [{flextable}](https://davidgohel.github.io/flextable/index.html), [{gt}](https://gt.rstudio.com/) and [{kableExtra}](https://haozhu233.github.io/kableExtra/) are often used for publication ready table visualization. Example of the last data frame previewed by `{flextable}` is shown below.

```{r spectral-data-read-norm-flextable}

# visualization of the first 10 rows by `{flextable}` with stripes
# (`theme_zebra()`) and pipe oerator "%>%" which is an expression 
# of a sequence of operations that transform an object
  flextable::flextable(head(tmpd.data.norm.02, n = 10)) %>%
    flextable::theme_zebra()

```

In order to process data frames in other software tools different from `r icons::bioicons("R")` they may be exported into universal `.csv` table format like by `write.csv()` function ➨

```{r spectral-data-read-norm-csv-save}

write.csv(tmpd.data.norm.02,
  file = "tabs/TMPD_EPR_Norm_data02.csv",
  row.names = FALSE
)

```

# Data Visualization

All the data related to EPR spectroscopy can be visualized by the famous [{ggplot2}](https://ggplot2.tidyverse.org/) `r icons::icon_style(fontawesome("box-open"), fill = "brown")` and its [extensions](https://exts.ggplot2.tidyverse.org/gallery/) as well as by the interactive [{plotly}](https://plotly.com/r/) graphing library. While the first library/package (based on the "Grammar of Graphics"[^2] , see also [@WilkinsonGG2005]) is one of the most comprehensive system for data visualization, the second one represents a valuable alternative to processing/acquisition software at EPR spectrometers. Namely, the latter includes tools like zooming, panning, data/values hovering and [much more](https://plotly.com/r/configuration-options/). Combination of both approaches possesses literally endless possibilities how to visualize the data in electron paramagnetic resonance spectroscopy.

[^2]: *The Grammar of Graphics* is a concept how the graphs/plots are built. It is based on fact that graphs may consist of several component/layers (e.g. like data layer, geometry layer, aesthetic layer...etc) similarly to processing of a bitmap-image in the photo-editor. The term "*grammar*" corresponds to structure of a sentence in language and thus it may represent a structure of the graph/plot in R programming language.

## Static Plots by `{ggplot2}` and `{patchwork}`

The `plot_EPR_Specs()` is the essential function to plot individual EPR spectra as well as those within the series (e.g. like time series $\equiv$ kinetic measurements). Now, by means of this function and by the [{patchwork}](https://patchwork.data-imaginist.com/) `r icons::icon_style(fontawesome("box-open"), fill = "brown")` , we can compare the EPR spectra with basic and "advanced" normalization ➨

```{r spectral-data-norm01-visual,fig.cap="EPR spectrum of $\\ce{TMPD^{.+}}$ in $0.3\\,\\mathrm{M}~\\ce{TBAPF6}/\\ce{DMSO}$ after potentiostatic oxidative electrolysis at $0.308\\,\\mathrm{V}$ vs Ag-quasiref. Intensity normalized by number of scans, 'Nscans', and by sensityvity Q-factor, 'qValue'."}

# Plotting the spectrum with basic normalization
# the B abscissa can be presented either in "mT" (default) or "G" 
# plot title is added by `ggtitle()` function from `{ggplot2}` package
tmpd.plot.norm.01 <- 
  plot_EPR_Specs(data.spectra = tmpd.data.norm.01) + 
  ggplot2::ggtitle("Basic Normalization")
#
# preview
tmpd.plot.norm.01

```

Comparison of both spectra with different normalization ➨

```{r spectral-data-norm0102-visual,fig.cap="Comparison of $\\ce{TMPD^{.+}}$ EPR spectra with different intensity normalization."}

# Spectrum with the "advanced" normalization 
tmpd.plot.norm.02 <- 
  plot_EPR_Specs(data.spectra = tmpd.data.norm.02) + 
  ggplot2::ggtitle("Advanced Normalization")
#
# Both spectra together by `{patchwork}` package
# without y/Intensity label (`ggplot2::labs(y = NULL)`) because 
# the EPR spectra will be displayed close to each other in two columns
tmpd.plot.norm.0102 <- 
  tmpd.plot.norm.01 + 
  tmpd.plot.norm.02 +
  ggplot2::labs(y = NULL)
#
# preview of EPR spectra with different intensities
tmpd.plot.norm.0102

```

If one wants to save the previous Figure \@ref(fig:spectral-data-norm0102-visual) the function `ggsave()` from `{ggplot2}` package can be used ➨

```{r spectral-data-norm0102-visua-save}

# to save plot `tmpd.plot.norm.0102` with the size
# of (7 x 5) inches and the resolution of dpi = 200
ggplot2::ggsave("imgs/TMPD_EPR_Norm_compar.png",
                plot = tmpd.plot.norm.0102,
                width = 7,
                height = 5,
                units = "in",
                dpi = 200)

# other image formats like `.pdf`, `.tex`,`.jpeg`, `.eps`,
# `.bmp`, `.svg` or `.tiff` can be used as well

```

## Interactive Plots by `{plotly}`

In order to explore the EPR spectrum in details (to read values, zoom or save the spectrum), function `plot_EPR_Specs2D_interact()` is applied. Additionally, it can be also used for series of EPR spectra similarly like `plot_EPR_Specs()`. The last spectrum with the advanced normalization can be plotted like ➨

```{r spectral-data-norm02-visual}

# preview + by hovering over the spectrum a toolbar appears in the upper 
# right corner + `B`, `dIepr_over_dB` values can be read directly from the spectrum
plot_EPR_Specs2D_interact(data.spectra = tmpd.data.norm.02)


```

Additional interactive 3D-plotting of EPR spectra, especially those recorded as time series, like during the kinetic or variable temperature experiments is described in other vignettes and provided by the `plot_EPR_ Specs3D_interact()` function.

# Basic EPR Spectral Characteristics

There are four basic parameters to characterize the EPR spectrum ➨

1.  Spectrum position expressed by the $g_{\mathrm{iso}}$-value

2.  Linewidth, for derivative line form expressed by $\Delta B_{\mathrm{pp}}$, that is the difference between $B_{\mathrm{max}}$ and $B_{\mathrm{min}}$ corresponding to position of maximal and minimal intensity, respectively. For the integrated spectral form the linewidth is expressed by $FWHM$ ("full width at half-maximum" or "full width at half-height").

3.  Hyperfine splitting, $a$ (in $\mathrm{mT}$ or $\mathrm{G}$) which is the distance between the individual lines corresponding to interaction of the unpaired electron with the group of surrounding equivalent nuclei.

4.  Single or double integral depending on the original spectral line form ➨ either integrated or derivative, respectively. This is directly proportional to the number of paramagnetic species/radicals.

## Finding the $g_{\mathrm{iso}}$-Value

The parameter is defined by the following Equation \@ref(eq:gfactor):

```{=tex}
\begin{equation}
g_{\mathrm{iso}} = \frac{h\,\nu}{\mu_{\mathrm{B}}\,B_0}
(\#eq:gfactor)
\end{equation}
```
where the $h$ and $\mu_{\mathrm{B}}$ are Plank's and Bohr magneton constants, respectively. Therefore, it is determined only by the microwave frequency ($\nu$) and the magnetic flux density ($B_0$) of the spectrum mid-point where $\mathrm{d}I_{\mathrm{EPR}}/\mathrm{d}B = 0$ (see function `eval_gFactor_Spec()`).

```{r spectral-data-norm02-gvalue}

# reading the frequency from the `.par` file
tmpd.mw.freq <- 
  readEPR_param_slct(tmpd.params.file,
  string = "MF",
  origin = "winepr"
)
# B region (349.677, 350.457) mT, incl. the B mid-point, to calculate 
# the g-value is obtained from interactive plot above
tmpd.g.iso.spec <- 
  eval_gFactor_Spec(tmpd.data.norm.02,
  nu.GHz = tmpd.mw.freq,
  B = "B_mT",
  B.unit = "mT",
  Blim = c(349.677, 350.457)
)
#
tmpd.g.iso.spec

```

The above (from spectrum) obtained $g_{\mathrm{iso}}$-value may be compared with that computed by Density Functional Theory (DFT) quantum chemical calculations of $\ce{TMPD^{.+}}$, namely by PBE0/EPR-II/CPCM-DMSO//B3LYP/6-31+G(d,p) (see also [Gaussian DFT Methods](https://gaussian.com/dft/) and [Basis Sets](https://gaussian.com/basissets/)). The extraction of $g_{\mathrm{iso}}$-value from the *Gaussian* (or from the [ORCA quantum chemical package](https://www.orcasoftware.de/tutorials_orca/index.html)) output file is provided by the `eval_gFactor_QCHcomp()` function ➨

```{r dft-data-norm02-gvalue}

# built-in package file => "TMPDAradCatEPRa.inp.log.zip"
gauss.tmpd.load <- load_data_example(file = "TMPDAradCatEPRa.inp.log.zip")
gauss.tmpd.output <- unzip(gauss.tmpd.load)
#
# giso-Value
tmpd.g.iso.dft <- eval_gFactor_QCHcomp(gauss.tmpd.output)
# preview
tmpd.g.iso.dft
#
# comparison of both theoretical and experimental g-values 
# with the tolerance of 1e-3
all.equal(tmpd.g.iso.spec,tmpd.g.iso.dft,tolerance = 1e-3)

```

The `TRUE` value represents a perfect agreement between the theoretically (`2.00317`) and the experimentally (`2.00304`) determined $g_{\mathrm{iso}}$-values and thus confirms position of the $\ce{TMPD^{.+}}$ EPR spectrum. Its difference from the free electron $g_{\mathrm{e}}\approx 2.00232$ is a consequence of a [spin-orbit coupling (SOC)](https://chem.libretexts.org/Bookshelves/Physical_and_Theoretical_Chemistry_Textbook_Maps/Electron_Paramagnetic_Resonance_(Jenschke)/03%3A_Electron_Zeeman_Interaction/3.01%3A_Physical_origin_of_the_(g)_shift) of the unpaired electron within the described radical cation structure. Namely, it tells how the individual atomic orbitals contributes to single occupied molecular orbital (SOMO), i.e. the orbital characterizing the "unpaired" electronic state. Therefore, for $\ce{TMPD^{.+}}$ the SOC is not so pronounced because of the small difference from $g_{\mathrm{e}}$. However, for heavy atoms (e.g. central atoms in metal complexes) the difference is often large and indicates larger SOC than for organic radicals like for the one mentioned above [@Weilepr2007].

## Linewidth, $\Delta B_{\mathrm{pp}}$ Determination

The linewidth in $\mathrm{mT}$ can be determined from several spectral lines/regions from the interactive plot above and by the `eval_DeltaXpp_Spec()` function ➨

```{r spectral-data-norm02-linewidth}

# selected B regions to calculate Delta Bpp
# as a list of three elements
B.regions.mT <- list(
  c(349.677, 349.977),
  c(349.177, 349.492),
  c(350.822, 351.072)
)
#
# all Delta Bpp as vector created by the iteration 
# through each element of `B.regions.mT` (by function `sapply()`)
tmpd.delta.Bpp <- sapply(
  B.regions.mT,
  function(b) {
    eval_DeltaXpp_Spec(tmpd.data.norm.02,
      xlim = b)
  }
)
#
# mean value
tmpd.delta.Bpp.mean <- 
  round(mean(tmpd.delta.Bpp),digits = 2)
#
tmpd.delta.Bpp.mean

```

-   Quantifying the number of paramagnetic species (e.g. radicals) based on integrated forms of derivative EPR spectra and instrumental parameters. In this respect also baseline polynomial corrections are included to precisely evaluate the double integrals by numeric [trapezoidal method](https://mathworld.wolfram.com/TrapezoidalRule.html). In case of lower signal-to-noise ratios i.e. in noisy EPR spectra, they can be optimized by least-square fitting of simulated ones (e.g. from EasySpin) and single or double integrals can be evaluated using the optimized intensity of the simulated EPR spectrum. This is particularly advantageous in (time) series of many noisy EPR spectra. Such operations have been available only on EPR instruments/spectrometers, up to now.

# References {.unnumbered}
